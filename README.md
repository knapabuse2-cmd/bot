# Telegram Outreach System - Natural Dialogue

Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ñ ĞµÑÑ‚ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¼ Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸ĞµĞ¼.

## ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸

### Ğ•ÑÑ‚ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾Ğµ Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ
- **Message Batching** â€” Ğ¶Ğ´Ñ‘Ñ‚ Ğ¿Ğ¾ĞºĞ° user Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ñ‚ Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ°Ñ‚ÑŒ (3 ÑĞµĞº Ğ¿Ğ°ÑƒĞ·Ğ°)
- **Read Receipts** â€” Ğ¾Ñ‚Ğ¼ĞµÑ‡Ğ°ĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ (âœ“âœ“)
- **Typing Simulation** â€” Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ "Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ°ĞµÑ‚..." Ğ¿Ñ€Ğ¾Ğ¿Ğ¾Ñ€Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ğ¸Ğ½Ğµ
- **Message Splitting** â€” Ñ€Ğ°Ğ·Ğ±Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ½Ğ° Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ¿Ğ¾ `|||`

### Ğ¡Ğ¿ĞµÑ†ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ AI
| ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° | Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ |
|---------|----------|
| `[SEND_LINKS]` | ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑÑÑ‹Ğ»ĞºĞ¸ Ğ¸Ğ· campaign, Ğ¿Ğ¾Ğ¼ĞµÑ‡Ğ°ĞµÑ‚ goal_reached |
| `[NEGATIVE_FINISH]` | Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ°ĞµÑ‚ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³ (Ğ¾Ñ‚ĞºĞ°Ğ·/Ğ³Ñ€ÑƒĞ±Ğ¾ÑÑ‚ÑŒ/Ğ¾Ñ„Ñ„Ñ‚Ğ¾Ğ¿) |
| `[CREATIVE_SENT]` | ĞŸĞ¾Ğ¼ĞµÑ‡Ğ°ĞµÑ‚ Ñ‡Ñ‚Ğ¾ ĞºÑ€ĞµĞ°Ñ‚Ğ¸Ğ² Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½ |
| `[HANDOFF]` | Ğ¡Ñ‚Ğ°Ğ²Ğ¸Ñ‚ Ğ½Ğ° Ğ¿Ğ°ÑƒĞ·Ñƒ Ğ´Ğ»Ñ Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ |

## Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°

```
src/
â”œâ”€â”€ application/
â”‚   â”œâ”€â”€ prompts.py                    # ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹ (CRYPTO_TRADER_PROMPT)
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ dialogue_processor.py     # Parser, Batcher, Typing
â”‚       â””â”€â”€ account_auth.py           # 2FA Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
â”œâ”€â”€ infrastructure/
â”‚   â”œâ”€â”€ telegram/
â”‚   â”‚   â””â”€â”€ client.py                 # Telegram ĞºĞ»Ğ¸ĞµĞ½Ñ‚ (read/typing)
â”‚   â”œâ”€â”€ database/repositories/
â”‚   â”‚   â”œâ”€â”€ dialogue_repo.py          # Ğ ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ redis/
â”‚       â””â”€â”€ locks.py                  # Distributed locks
â””â”€â”€ workers/
    â””â”€â”€ natural_worker.py             # ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ worker
```

## Flow Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°

```
User sends messages
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MessageBatcher   â”‚  â† Ğ–Ğ´Ñ‘Ñ‚ 3 ÑĞµĞº Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  mark_as_read()   â”‚  â† Ğ“Ğ°Ğ»Ğ¾Ñ‡ĞºĞ¸ âœ“âœ“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Reading delay    â”‚  â† 1-8 ÑĞµĞº (Ğ¿Ğ¾ Ğ´Ğ»Ğ¸Ğ½Ğµ Ñ‚ĞµĞºÑÑ‚Ğ°)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI Generation    â”‚  â† Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ResponseParser   â”‚  â† Split Ğ¿Ğ¾ ||| + extract command
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  type_and_wait()  â”‚  â† "Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ°ĞµÑ‚..." 1-12 ÑĞµĞº
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  send_message()   â”‚  â† ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ°
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
   (repeat for each message)
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Handle Action    â”‚  â† SEND_LINKS / NEGATIVE_FINISH / etc
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°

```
[00:00] BOT â†’ "Ñ‚Ñ‹ Ğ½Ğ° Ñ„ÑŒÑÑ‡Ğ°Ñ… Ñ‚Ğ¾Ñ€Ğ³ÑƒĞµÑˆÑŒ Ğ¸Ğ»Ğ¸ ÑĞ¿Ğ¾Ñ‚?"
        
[00:15] USER â†’ "Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ¿Ğ¾Ñ‚ Ğ¿Ğ¾ĞºĞ°"
        â”œâ”€ Batcher Ğ¶Ğ´Ñ‘Ñ‚ 3 ÑĞµĞº
        â”œâ”€ Mark as read âœ“âœ“
        â”œâ”€ Reading delay 2 ÑĞµĞº
        â”œâ”€ AI: "Ğ¿Ğ¾Ğ½ÑĞ» ||| Ğ° Ğ´Ğ°Ğ²Ğ½Ğ¾ Ğ² ĞºÑ€Ğ¸Ğ¿Ñ‚Ğµ?"
        â”œâ”€ Typing 3 ÑĞµĞº â†’ Send "Ğ¿Ğ¾Ğ½ÑĞ»"
        â”œâ”€ Pause 1.5 ÑĞµĞº
        â””â”€ Typing 4 ÑĞµĞº â†’ Send "Ğ° Ğ´Ğ°Ğ²Ğ½Ğ¾ Ğ² ĞºÑ€Ğ¸Ğ¿Ñ‚Ğµ?"

[01:00] USER â†’ "ÑĞ»ÑƒÑˆĞ°Ğ¹ Ğ° ĞµÑÑ‚ÑŒ Ğ½Ğ¾Ñ€Ğ¼ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹?"
        â”œâ”€ AI: "ĞµÑÑ‚ÑŒ Ğ¿Ğ°Ñ€Ğ° ||| ÑĞ°Ğ¼ Ğ´Ğ¾Ğ»Ğ³Ğ¾ Ğ¸ÑĞºĞ°Ğ» ||| Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ ÑĞºĞ¸Ğ½Ñƒ?" [CREATIVE_SENT]
        â”œâ”€ Send 3 messages
        â””â”€ dialogue.creative_sent = True

[01:30] USER â†’ "Ğ´Ğ°Ğ²Ğ°Ğ¹"
        â”œâ”€ AI: "Ğ»Ğ¾Ğ²Ğ¸ [SEND_LINKS]"
        â”œâ”€ Send "Ğ»Ğ¾Ğ²Ğ¸"
        â”œâ”€ Send campaign links
        â””â”€ dialogue.status = GOAL_REACHED âœ“
```

## Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

```python
from src.application.prompts import get_crypto_trader_prompt

# ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚
prompt = get_crypto_trader_prompt(
    links="https://t.me/channel1\nhttps://t.me/channel2"
)

# Ğ˜Ğ»Ğ¸ ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ñ‹Ğ¹
from src.application.prompts import build_custom_prompt

prompt = build_custom_prompt(
    role="Ğ¢Ñ‹ Ğ¸Ğ½Ğ²ĞµÑÑ‚Ğ¾Ñ€ Ñ 5-Ğ»ĞµÑ‚Ğ½Ğ¸Ğ¼ Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğ¼...",
    goal="ĞŸÑ€Ğ¸Ğ²ĞµÑÑ‚Ğ¸ Ğº Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞµ Ğ½Ğ° ĞºĞ°Ğ½Ğ°Ğ»",
    links="https://t.me/mychannel",
)
```

## Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°

```bash
tar -xzf telegram-outreach-fixes.tar.gz
cp -r telegram-outreach-fixes/* /path/to/project/

# ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸
alembic upgrade head

# Ğ—Ğ°Ğ¿ÑƒÑĞº
python -m src.workers.main
```

## Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹

- âœ… Session lifecycle (fresh session per operation)
- âœ… Race conditions (distributed locks + FOR UPDATE)
- âœ… Memory leaks (proper task cleanup)
- âœ… Redis connection leaks
- âœ… Optimistic locking
- âœ… 2FA support
- âœ… Natural dialogue (batching, typing, splitting)

### ğŸ”´ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ

#### 1. Session Lifecycle Ğ² WorkerManager
**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°**: Session Ğ·Ğ°ĞºÑ€Ñ‹Ğ²Ğ°Ğ»Ğ°ÑÑŒ Ğ¿Ğ¾ÑĞ»Ğµ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ° Ğ¸Ğ· `async with`, Ğ½Ğ¾ worker Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°Ğ» Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ.

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ**: Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½ Session Factory â€” ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ worker Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ÑĞµÑÑĞ¸Ğ¹ per-operation.

**Ğ¤Ğ°Ğ¹Ğ»**: `src/workers/manager.py`

#### 2. Race Condition Ğ² Target Distribution
**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°**: Ğ”Ğ²Ğ° concurrent Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ° Ğ¼Ğ¾Ğ³Ğ»Ğ¸ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ÑŒ Ğ¾Ğ´Ğ¸Ğ½ target Ñ€Ğ°Ğ·Ğ½Ñ‹Ğ¼ accounts.

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ**: 
- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ `DistributedLock` Ñ‡ĞµÑ€ĞµĞ· Redis
- ĞœĞµÑ‚Ğ¾Ğ´ `list_pending_for_update()` Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ `SELECT ... FOR UPDATE SKIP LOCKED`

**Ğ¤Ğ°Ğ¹Ğ»Ñ‹**: 
- `src/infrastructure/redis/locks.py`
- `src/infrastructure/database/repositories/target_repo.py`

#### 3. Memory Leak Ğ² AccountWorker
**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°**: ĞŸÑ€Ğ¸ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¼ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğµ `start()` ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ task Ñ‚ĞµÑ€ÑĞ»ÑÑ.

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ**: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¸ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ³Ğ¾ task Ğ¿ĞµÑ€ĞµĞ´ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸ĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾.

**Ğ¤Ğ°Ğ¹Ğ»**: `src/workers/account_worker.py`

#### 4. Redis Connection Ğ½Ğµ Ğ·Ğ°ĞºÑ€Ñ‹Ğ²Ğ°Ğ»Ğ°ÑÑŒ
**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°**: Ğ’ `on_shutdown` Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ» Ğ²Ñ‹Ğ·Ğ¾Ğ² `close_redis()`.

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ**: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ²Ñ‹Ğ·Ğ¾Ğ² `close_redis()` Ğ²Ğ¾ Ğ²ÑĞµ Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ°.

**Ğ¤Ğ°Ğ¹Ğ»**: `src/presentation/admin_bot/main.py`

---

### ğŸŸ¡ Ğ¡ĞµÑ€ÑŒÑ‘Ğ·Ğ½Ñ‹Ğµ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ

#### 5. Optimistic Locking
**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°**: ĞŸĞ¾Ğ»Ğµ `version` Ğ½Ğµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞ»Ğ¾ÑÑŒ Ğ¿Ñ€Ğ¸ save.

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ**: Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ² `BaseRepository.save()`.

**Ğ¤Ğ°Ğ¹Ğ»**: `src/infrastructure/database/repositories/base.py`

#### 6. Thread-Safe AI Provider Singleton
**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°**: Race condition Ğ¿Ñ€Ğ¸ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ singleton.

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ**: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ `asyncio.Lock` Ğ´Ğ»Ñ thread-safe Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸.

**Ğ¤Ğ°Ğ¹Ğ»**: `src/infrastructure/ai/openai_provider.py`

#### 7. ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ»Ğ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° 2FA
**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°**: `SessionPasswordNeededError` Ğ½Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ğ»Ğ°ÑÑŒ.

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ**: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ñ†ĞµĞ½Ğ½Ñ‹Ğ¹ `AccountAuthService` Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹ Ğ²ÑĞµÑ… ÑÑ‚Ğ°Ğ¿Ğ¾Ğ² Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸.

**Ğ¤Ğ°Ğ¹Ğ»**: `src/application/services/account_auth.py`

---

## ğŸ“ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹

```
telegram-outreach-fixes/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ settings.py              # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸
â”‚   â”œâ”€â”€ workers/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ main.py                  # Entry point Ğ´Ğ»Ñ worker manager
â”‚   â”‚   â”œâ”€â”€ manager.py               # Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ manager
â”‚   â”‚   â””â”€â”€ account_worker.py        # Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ worker
â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â”‚   â””â”€â”€ repositories/
â”‚   â”‚   â”‚       â”œâ”€â”€ base.py          # Ğ¡ optimistic locking
â”‚   â”‚   â”‚       â”œâ”€â”€ account_repo.py  # Ğ¡ counter reset methods
â”‚   â”‚   â”‚       â””â”€â”€ target_repo.py   # Ğ¡ FOR UPDATE
â”‚   â”‚   â”œâ”€â”€ redis/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â””â”€â”€ locks.py             # Distributed locks
â”‚   â”‚   â””â”€â”€ ai/
â”‚   â”‚       â””â”€â”€ openai_provider.py   # Thread-safe singleton
â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â””â”€â”€ services/
â”‚   â”‚       â””â”€â”€ account_auth.py      # 2FA support
â”‚   â””â”€â”€ presentation/
â”‚       â””â”€â”€ admin_bot/
â”‚           â””â”€â”€ main.py              # Proper shutdown
â”œâ”€â”€ migrations/
â”‚   â”œâ”€â”€ env.py                       # Alembic environment
â”‚   â””â”€â”€ script.py.mako               # Migration template
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ conftest.py                  # Pytest fixtures
â”‚   â””â”€â”€ unit/
â”‚       â”œâ”€â”€ domain/
â”‚       â”‚   â””â”€â”€ test_entities.py     # Domain tests
â”‚       â””â”€â”€ infrastructure/
â”‚           â””â”€â”€ test_locks.py        # Lock tests
â””â”€â”€ README.md
```

---

## ğŸš€ Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ Ğ¿Ğ¾ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ

### 1. Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹

```bash
# Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ²ÑĞµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¸Ğ· telegram-outreach-fixes Ğ² Ğ²Ğ°Ñˆ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚
cp -r telegram-outreach-fixes/* /path/to/your/project/
```

### 2. Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°ÑÑ‰Ğ¸Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸

```bash
# Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ² pyproject.toml ĞµÑĞ»Ğ¸ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚
pip install aiosqlite  # Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¾Ğ²
```

### 3. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ

```bash
cd /path/to/your/project

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹
mkdir -p migrations/versions

# Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ
alembic revision --autogenerate -m "Initial migration"

# ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ
alembic upgrade head
```

### 4. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ Ñ‚ĞµÑÑ‚Ñ‹

```bash
# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ dev Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
pip install -e ".[dev]"

# Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ Ñ‚ĞµÑÑ‚Ñ‹
pytest tests/ -v

# Ğ¡ coverage
pytest tests/ -v --cov=src --cov-report=html
```

### 5. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ

```bash
# Ğ§ĞµÑ€ĞµĞ· Docker
docker-compose up -d

# Ğ˜Ğ»Ğ¸ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾ (Ğ² Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ»Ğ°Ñ…)
python -m src.presentation.admin_bot.main  # Admin Bot
python -m src.workers.main                  # Worker Manager
```

---

## âš ï¸ Breaking Changes

### WorkerManager.start_worker()
**Ğ‘Ñ‹Ğ»Ğ¾**: ĞŸÑ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ» `Account` entity
**Ğ¡Ñ‚Ğ°Ğ»Ğ¾**: ĞŸÑ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ `UUID` account_id

```python
# Ğ‘Ñ‹Ğ»Ğ¾
await manager.start_worker(account)

# Ğ¡Ñ‚Ğ°Ğ»Ğ¾
await manager.start_worker(account.id)
```

### AccountWorker.__init__()
**Ğ‘Ñ‹Ğ»Ğ¾**: ĞŸÑ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ» Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğµ services
**Ğ¡Ñ‚Ğ°Ğ»Ğ¾**: ĞŸÑ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ session_factory

```python
# Ğ‘Ñ‹Ğ»Ğ¾
worker = AccountWorker(
    account=account,
    account_service=account_service,
    dialogue_service=dialogue_service,
)

# Ğ¡Ñ‚Ğ°Ğ»Ğ¾
worker = AccountWorker(
    account=account,
    session_factory=get_session,
    ai_provider=get_ai_provider(),
)
```

---

## ğŸ“Š ĞŸĞ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ñ‚ĞµÑÑ‚Ğ°Ğ¼Ğ¸

| ĞœĞ¾Ğ´ÑƒĞ»ÑŒ | ĞŸĞ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ |
|--------|----------|
| Domain Entities | âœ… 90%+ |
| Redis Locks | âœ… 85%+ |
| Repositories | â³ To Do |
| Services | â³ To Do |
| Workers | â³ To Do |

---

## ğŸ”œ Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ½Ğ° Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞµ

1. **Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ integration tests** Ñ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ PostgreSQL/Redis Ñ‡ĞµÑ€ĞµĞ· testcontainers
2. **Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ circuit breaker** Ğ´Ğ»Ñ OpenAI provider
3. **Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ metrics** (Prometheus/Grafana)
4. **ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ CI/CD** Ñ GitHub Actions
5. **Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ rate limiter** Ğ´Ğ»Ñ REST API

---

## ğŸ“ Changelog

### v1.0.0 (2024-XX-XX)
- âœ… Fixed session lifecycle in WorkerManager
- âœ… Added distributed locks for target assignment
- âœ… Fixed memory leak in AccountWorker
- âœ… Added proper shutdown sequence
- âœ… Implemented optimistic locking
- âœ… Thread-safe AI provider singleton
- âœ… Full 2FA support
- âœ… Added unit tests
- âœ… Added Alembic migrations setup
